name: Build Assets

on:
  push:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.cdn_branch }}
  cancel-in-progress: true

env:
  DEPOT_DOWNLOADER_USERNAME: ${{ secrets.DEPOT_DOWNLOADER_USERNAME }}
  DEPOT_DOWNLOADER_PASSWORD: ${{ secrets.DEPOT_DOWNLOADER_PASSWORD }}

jobs:
  download_client:
    name: Download client
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup DepotDownloader
        run: |
          mkdir -p temp

          echo "Downloading..."
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/SteamRE/DepotDownloader/releases/latest | \
            grep -i "linux-x64" | \
            grep "browser_download_url" | \
            cut -d '"' -f 4)
          curl -L "$DOWNLOAD_URL" -o temp/depotDownloader.zip

          echo "Unzipping..."
          unzip temp/depotDownloader.zip -d temp/depotDownloader

          echo "Download complete; files:"
          ls temp/depotDownloader

      - name: (Steam) Download client
        run: |
          chmod +x temp/depotDownloader/DepotDownloader
          temp/depotDownloader/DepotDownloader -q -os windows -depot 3341251 -username "${{ env.DEPOT_DOWNLOADER_USERNAME }}" -password "${{ env.DEPOT_DOWNLOADER_PASSWORD }}"
