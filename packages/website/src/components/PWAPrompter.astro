---
import { Cross1Icon, Cross2Icon, DownloadIcon } from "@radix-ui/react-icons";
import {
  Badge,
  Box,
  Button,
  Card,
  Flex,
  Inset,
  Link,
  Spinner,
  Text,
} from "@radix-ui/themes";
import { getStrings } from "../core/i18n/getStrings";
import type { LocaleAcceptorProps } from "../hooks/useLocale";

type Props = LocaleAcceptorProps & {
  floating?: boolean;
};

const { locale, floating } = Astro.props;
const strings = getStrings(locale);
---

<style>
  #pwa-prompter[data-floating="true"] {
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: 1;
  }

  #pwa-prompter[data-floating="true"] .card {
    box-shadow: var(--shadow-6);
  }

  .pwa-logo {
    width: 6rem;
    height: 6rem;
    background-image: url(/assets/images/pwa-promo.png);
    background-position: center;
    background-size: cover;
  }

  html.pwa-enabled .compatibility-checker,
  html.pwa-disabled .compatibility-checker {
    display: none;
  }

  #pwa-install,
  #pwa-incompatible,
  #pwa-prompter[data-floating="true"],
  #pwa-dismiss {
    display: none;
  }

  html.pwa-enabled #pwa-install,
  html.pwa-disabled #pwa-incompatible,
  html.pwa-enabled #pwa-prompter[data-floating="true"],
  #pwa-prompter[data-floating="true"] #pwa-dismiss {
    display: unset;
  }

  .pwa-actions button {
    flex: 1;
  }
</style>

<script>
  import { pwaInstallHandler } from "pwa-install-handler";

  const pwaInstallButton = document.getElementById("pwa-install");
  const pwaDismissButton = document.getElementById("pwa-dismiss");
  const pwaPrompter = document.getElementById("pwa-prompter");

  pwaInstallButton?.addEventListener("click", () => {
    pwaInstallHandler.install();
  });

  pwaDismissButton?.addEventListener("click", () => {
    pwaPrompter?.remove();
  });
</script>

<Flex id="pwa-prompter" justify="center" mt="4" data-floating={floating}>
  <Card variant="classic" className="card">
    <Inset>
      <Flex align="center">
        <Box className="pwa-logo" />

        <Flex direction="column" gap="2" px="4" py="3">
          <Flex align="center" gap="2">
            <Text size="4" weight="medium">
              {strings.website.home.pwa.title}
            </Text>
            <Badge color="jade" variant="outline">
              {strings.website.home.pwa.new}
            </Badge>
          </Flex>

          <Flex className="compatibility-checker" align="center" gap="2">
            <Spinner />
            <Text color="gray">
              {strings.website.home.pwa.checking}
            </Text>
          </Flex>

          <Link
            id="pwa-incompatible"
            trim="end"
            underline="always"
            target="_blank"
            href="https://www.cdc.gov/niosh/mining/tools/installpwa.html"
          >
            {strings.website.home.pwa.instructions}
          </Link>

          <Flex className="pwa-actions" gap="2">
            <Button id="pwa-dismiss" color="tomato" variant="outline">
              <Flex align="center" gap="1" justify="center">
                <Cross2Icon />
                {strings.website.home.pwa.dismiss}
              </Flex>
            </Button>
            <Button id="pwa-install" color="jade">
              <Flex align="center" gap="1" justify="center">
                <DownloadIcon />
                {strings.website.home.pwa.install}
              </Flex>
            </Button>
          </Flex>
        </Flex>
      </Flex>
    </Inset>
  </Card>
</Flex>
