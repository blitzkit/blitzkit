---
import { OpenInNewWindowIcon } from '@radix-ui/react-icons';
import {
  Code,
  Flex,
  Heading,
  Link,
  Separator,
  Text,
  type CodeProps,
} from '@radix-ui/themes';
import type { GetStaticPaths, GetStaticPathsOptions } from 'astro';
import { PageWrapper } from '../../../components/PageWrapper';
import { apiTool } from '../../../constants/tools';
import ToolLayout from '../../../layouts/ToolLayout.astro';
import { SlugsTable } from './_index';

export { getStaticPaths } from '../index.astro';

interface Tag {
  tag: string;
  discriminator?: string;
  description?: string;
}

export interface APIPath {
  path: string;
  content: string;
  comment: string;
  tags: Tag[];
  slugs?: {
    titles: string[];
    groups: SlugGroup[];
  };
}

type SlugGroup = Record<string, string | number | undefined>;

const getDocsRegex = /\/\*\*\n(( \*(.+)?\n?)+)\n \*\/\nexport const GET/;
const multiLineCommentPrefixRegex = /^ \* ?/gm;
const tagRegex = /(@[^\s]+)(?:\s(.+))?/;
const firstWordRegex = /(\S+)(?:\s(.+))?/;
const ROOT = '/src/pages/api/';
const globRaw = import.meta.glob('/src/pages/api/**/*.ts', {
  eager: true,
  query: '?raw',
  import: 'default',
}) as Record<string, string>;
const globStaticPaths = import.meta.glob('/src/pages/api/**/*.ts', {
  eager: true,
}) as Record<string, { getStaticPaths?: GetStaticPaths }>;
let apis: APIPath[] = [];

for (const rawPath in globRaw) {
  const content = globRaw[rawPath].replaceAll('\r', '');
  const regexExecution = content.match(getDocsRegex);
  const commentRaw = regexExecution?.[1];
  const { getStaticPaths } = globStaticPaths[rawPath];
  let slugs: APIPath['slugs'] | undefined;

  if (getStaticPaths) {
    const staticPaths = await getStaticPaths(
      undefined as unknown as GetStaticPathsOptions,
    );

    const titles = new Set<string>();

    slugs = {
      titles: [],
      groups: [],
    };

    staticPaths.forEach((path) => {
      Object.keys(path.params).forEach((key) => {
        titles.add(key);
      });
      slugs!.groups.push(path.params);
    });

    slugs.titles = [...titles];
  }

  if (!commentRaw) continue;

  const commentWithTags = commentRaw.replaceAll(
    multiLineCommentPrefixRegex,
    '',
  );
  const path = rawPath.replace(ROOT, '').replace('.ts', '');
  let comment = '';

  const tags: Tag[] = [];
  commentWithTags.split('\n').forEach((line) => {
    const match = line.match(tagRegex);

    if (match) {
      const tag = match[1];
      const descriptionRaw = match[2];
      let discriminator: string | undefined;
      let description: string | undefined;

      if (tag === '@param') {
        const firstWordMatch = descriptionRaw.match(firstWordRegex)!;
        discriminator = firstWordMatch[1];
        description = firstWordMatch[2];
      } else {
        description = descriptionRaw;
      }

      tags.push({
        tag,
        discriminator,
        description,
      });
    } else {
      comment += `${line}\n`;
    }
  });

  comment = comment.trim();
  apis.push({ path, content, comment, tags, slugs });
}

apis.sort((a, b) => a.path.localeCompare(b.path));
---

<ToolLayout tool={apiTool}>
  <PageWrapper py="8" color="indigo">
    <Flex direction="column" gap="6">
      {
        apis.map((api, index) => (
          <>
            <Flex direction="column" gap="5">
              <Link
                href={api.slugs ? undefined : `/api/${api.path}`}
                underline="always"
                target="_blank"
              >
                <Heading>
                  <Flex align="center" gap="2">
                    <Code variant="ghost">{api.path}</Code>

                    {!api.slugs && (
                      <OpenInNewWindowIcon width="1em" height="1em" />
                    )}
                  </Flex>
                </Heading>
              </Link>

              <Text>{api.comment}</Text>

              {api.tags.length > 0 && (
                <Flex direction="column" gap="2">
                  {api.tags.map(({ tag, description, discriminator }) => {
                    let color: CodeProps['color'] | undefined = undefined;

                    switch (tag) {
                      case '@warning':
                        color = 'amber';
                        break;
                    }

                    return (
                      <Flex gap="2">
                        <Code variant="solid" color={color}>
                          {tag}
                        </Code>

                        {discriminator && (
                          <Code color="gray" variant="solid" highContrast>
                            {discriminator}
                          </Code>
                        )}

                        {description && <Text color="gray">{description}</Text>}
                      </Flex>
                    );
                  })}
                </Flex>
              )}
            </Flex>

            <SlugsTable path={api.path} client:load slugs={api.slugs} />

            {index < apis.length - 1 && (
              <Separator size="4" style={{ height: 0.5 }} />
            )}
          </>
        ))
      }
    </Flex>
  </PageWrapper>
</ToolLayout>
