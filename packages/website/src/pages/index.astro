---
import { fetchAverageDefinitions, fetchTankDefinitions } from '@blitzkit/core';
import { Box, Flex, Heading } from '@radix-ui/themes';
import HomeHero from '../components/HomeHero.astro';
import { Plugs } from '../components/Plugs.tsx';
import { TankCard } from '../components/TankSearch/components/TankCard';
import ToolCard from '../components/ToolCard.astro';
import {
  compareTool,
  discordTool,
  embedTool,
  galleryTool,
  moreTool,
  performanceTool,
  sessionTool,
  tankopediaTool,
} from '../constants/tools';
import BaseLayout from '../layouts/BaseLayout.astro';

const tankDefinitions = await fetchTankDefinitions();
const averageDefinitions = await fetchAverageDefinitions();
const tanks = Object.values(tankDefinitions.tanks);
const tankAverages = Object.entries(averageDefinitions.averages).map(
  ([id, average]) => ({
    id: Number(id),
    ...average,
  }),
);

// lol don't ask questions
const testTanks = tanks
  .filter((tank) => tank.testing && tank.tier >= 8)
  .sort((a, b) => b.tier - a.tier);
const mostPlayedTanks = tankAverages
  .sort((a, b) => b.samples.d_1 - a.samples.d_1)
  .map(({ id }) => tankDefinitions.tanks[id])
  .filter(Boolean);
const popularTanks = [...testTanks, ...mostPlayedTanks].slice(0, 8);
---

<BaseLayout>
  <HomeHero />

  <Plugs client:idle />

  <Flex p="4" justify="center" gap="4" mt="3">
    <Flex maxWidth="64rem" flexGrow="1" gap="4" direction="column">
      <ToolCard tool={tankopediaTool} />

      <Flex direction="column" gap="4" pt="4" pb="8">
        <Heading align="center" size="5">Popular tanks</Heading>

        <Flex justify="center" gap="4" wrap="wrap">
          {
            popularTanks.map((tank) => (
              <Box width="7rem">
                <TankCard {tank} />
              </Box>
            ))
          }
        </Flex>
      </Flex>

      <Flex gap="4" direction={{ initial: 'column', sm: 'row' }}>
        {/* <ToolCard tool={playerStatsTool} /> */}
        <ToolCard tool={compareTool} />
        <ToolCard tool={performanceTool} />
      </Flex>

      <Flex gap="4" direction={{ initial: 'column', sm: 'row' }}>
        <ToolCard tool={galleryTool} />
        <ToolCard tool={sessionTool} />
        {/* <ToolCard tool={ratingTool} /> */}
      </Flex>

      <Flex gap="4" direction={{ initial: 'column', sm: 'row' }}>
        <ToolCard tool={embedTool} />
        <ToolCard tool={discordTool} />
      </Flex>

      <Flex gap="4" direction={{ initial: 'column', sm: 'row' }}>
        <ToolCard tool={moreTool} />
        <Box flexGrow="1" />
      </Flex>

      <Heading align="center" mt="6">Other cool projects</Heading>

      <Flex gap="4" mb="6" direction={{ initial: 'column', sm: 'row' }}>
        <ToolCard
          tool={{
            button: {
              text: 'Analyze',
              color: 'blue',
            },
            description: 'Rich historic average stats',
            id: 'blitz-analysis',
            image: 'j76YXGl',
            title: 'BlitzAnalysis[]',
            href: 'https://blitzanalysiz.com/',
          }}
        />
        <ToolCard
          tool={{
            button: {
              color: 'purple',
              text: 'Install',
              highContrast: true,
            },
            image: 'zYrrYbR',
            description: 'In-game session stats',
            id: 'blitz-insider',
            title: 'Blitz Insider',
            href: 'https://discord.gg/UjWf9eGgtR',
          }}
        />
      </Flex>
    </Flex>
  </Flex>

  <div style={{ flex: 1 }}></div>
</BaseLayout>
