---
import "@radix-ui/colors/amber-dark.css";
import {
  createProgram,
  displayPartsToString,
  forEachChild,
  isFunctionDeclaration,
} from "typescript";
import BaseLayout from "../../../layouts/BaseLayout.astro";

export { getStaticPaths } from "../index.astro";

const root = `/src/pages/api`;
const globbed = import.meta.glob("/src/pages/api/**/*", {
  eager: true,
  query: "?raw",
  import: "default",
});
const paths: {
  path: string;
  documentation: string;
}[] = [];

for (const fullPath in globbed) {
  const relativePath = `.${fullPath}`;
  const path = fullPath.slice(root.length + 1, -3);
  const program = createProgram([relativePath], {});
  const source = program.getSourceFile(relativePath);
  if (!source) throw new Error(`Could not find source for ${fullPath}`);

  const checker = program.getTypeChecker();

  const getter = forEachChild(source, (node) => {
    if (!isFunctionDeclaration(node) || node.name?.text !== "GET") return;
    return checker.getSymbolAtLocation(node.name);
  });

  const documentationComment = getter?.getDocumentationComment(checker);
  if (!documentationComment) continue;

  const documentation = displayPartsToString(documentationComment);
  if (documentation.length === 0) continue;

  paths.push({ path, documentation });
}

paths.sort((a, b) => a.path.localeCompare(b.path));
---

<BaseLayout accent="amber">
  <h1>api</h1>

  {
    paths.map(({ path, documentation }) => (
      <>
        <h2>{path}</h2>
        <pre>{documentation}</pre>
      </>
    ))
  }
</BaseLayout>
